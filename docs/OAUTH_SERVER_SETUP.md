# Настройка OAuth токенов для работы на сервере

## Проблема

При работе на сервере без интерактивного браузера возникает вопрос: как управлять OAuth токенами, если они истекают?

## Решение: Refresh Tokens

Google OAuth 2.0 поддерживает механизм **refresh tokens**, который позволяет автоматически обновлять access tokens без повторной авторизации пользователя.

### Как это работает:

1. **Первоначальная авторизация (один раз, локально):**
   - Запускаете `python scripts/bootstrap_oauth.py`
   - Выдаете разрешения в браузере
   - Получаете **access token** (живет ~1 час) и **refresh token** (живет долго, пока не отозван)

2. **На сервере:**
   - Сохраняете оба токена в безопасном месте
   - Когда access token истекает, используете refresh token для получения нового
   - Refresh token обычно работает **неограниченно долго**, пока:
     - Пользователь не отзовет доступ в настройках Google
     - Пользователь не изменит пароль (в некоторых случаях)
     - Токен не будет отозван вручную

### Важно: `access_type=offline`

Для получения refresh token необходимо при авторизации указать `access_type=offline`. 

В нашем коде это уже настроено через `InstalledAppFlow`, который по умолчанию запрашивает offline access.

## Рекомендуемая схема работы на сервере

### Вариант 1: OAuth 2.0 с Refresh Tokens (текущий подход)

**Плюсы:**
- Работает с личными аккаунтами пользователя
- Доступ к Gmail и Sheets пользователя
- Автоматическое обновление токенов

**Минусы:**
- Требует первоначальной авторизации (один раз)
- Если refresh token отозван - нужна повторная авторизация
- Токены привязаны к конкретному пользователю

**Процесс:**
1. Локально: `python scripts/bootstrap_oauth.py` → получаете токены
2. Загружаете файлы `token_gmail.json` и `token_sheets.json` на сервер
3. На сервере: код автоматически обновляет access tokens через refresh tokens
4. Если refresh token истекает → получаете уведомление, повторяете шаг 1

**Мониторинг:**
- Настройте алерты на ошибки `TokenExpiredError`
- Логируйте успешные обновления токенов
- Периодически проверяйте валидность refresh tokens

### Вариант 2: Service Account (для корпоративных сценариев)

**Когда использовать:**
- Если нужен доступ к корпоративным ресурсам (Google Workspace)
- Если не нужен доступ к личному Gmail пользователя
- Для server-to-server коммуникации без пользователя

**Плюсы:**
- Не требует интерактивной авторизации
- Токены не истекают (используется JWT)
- Более безопасно для production

**Минусы:**
- Не работает с личным Gmail (только Workspace)
- Требует настройки в Google Cloud Console
- Нужно делиться таблицами с service account email

**Процесс:**
1. Создаете Service Account в Google Cloud Console
2. Скачиваете JSON ключ
3. Делитесь таблицей с email service account
4. Используете ключ вместо OAuth токенов

## Текущая реализация

Наш код уже поддерживает:

1. ✅ **Автоматическое обновление токенов** - `ensure_valid_credentials()` обновляет access token через refresh token
2. ✅ **Обработка истечения refresh token** - выбрасывается `TokenExpiredError` с понятным сообщением
3. ✅ **Опциональная автоматическая переавторизация** - через `AUTO_REAUTHORIZE=true` (но это требует браузера, не работает на сервере)

## Рекомендации для production

### 1. Безопасное хранение токенов

```bash
# На сервере используйте:
- Переменные окружения (для секретов)
- Зашифрованные файлы
- Secrets manager (AWS Secrets Manager, HashiCorp Vault и т.д.)
- Минимальные права доступа к файлам (chmod 600)
```

### 2. Мониторинг и алерты

```python
# Настройте мониторинг:
- Логирование всех обновлений токенов
- Алерты на TokenExpiredError
- Метрики успешности обновлений
```

### 3. Резервное копирование

```bash
# Регулярно бэкапьте токены:
- Сохраняйте refresh tokens в безопасном месте
- Имейте план восстановления при потере токенов
```

### 4. Ротация токенов

Google может периодически выдавать новые refresh tokens. Наш код автоматически сохраняет обновленные токены.

### 5. Обработка отзыва токенов

Если пользователь отозвал доступ:
- Получите уведомление через `TokenExpiredError`
- Свяжитесь с пользователем для повторной авторизации
- Или используйте Service Account для критичных процессов

## Часто задаваемые вопросы

**Q: Как часто нужно обновлять токены?**
A: Access tokens обновляются автоматически при истечении (~1 час). Refresh tokens работают долго, обычно до отзыва.

**Q: Что делать, если refresh token истек?**
A: Запустите `python scripts/bootstrap_oauth.py` локально, получите новые токены, загрузите на сервер.

**Q: Можно ли автоматизировать получение новых refresh tokens?**
A: Нет, для OAuth 2.0 требуется интерактивная авторизация пользователя. Для полной автоматизации используйте Service Account.

**Q: Безопасно ли хранить refresh tokens на сервере?**
A: Да, если соблюдены меры безопасности (шифрование, ограниченный доступ, secrets manager).

## Дополнительные ресурсы

- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Refresh Token Best Practices](https://developers.google.com/identity/protocols/oauth2/web-server#offline)
- [Service Accounts Guide](https://cloud.google.com/iam/docs/service-accounts)

